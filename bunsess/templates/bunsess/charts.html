{% extends "base1.html" %}
{% load i18n %}
{% load static %}
{% block extra_css %}
    <style xmlns="http://www.w3.org/1999/html">
    </style>
{% endblock %}
{% block page_title %}
 Chart
{% endblock page_title %}
{% block content %}
    <div class="page-breadcrumb">
        <div class="row">
            <div class="col-12 d-flex no-block align-items-center">
                <h4 class="page-title">Buniness Intélligence</h4>
                <div class="ml-auto text-right">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">bi</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Container fluid  -->
    <!-- ============================================================== -->
    <div class="container-fluid">
        <!-- ============================================================== -->
        <!-- Start Page Content -->
        <!-- ============================================================== -->
        <!-- Chart-1 -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <form method="get" id="filterRpport">
                        <label for="" class="form-label font-italic font-weight-bold text-success">du</label>
                        <input type="date" name="start_date" id="start_date" class="text-success font-italic font-weight-bold" required>
                        <label for="" class="form-label font-italic font-weight-bold text-success">au</label>
                        <input type="date" name="end_date" id="end_date" class="text-success font-italic font-weight-bold" required>
                        &nbsp; &nbsp;
                        <select name="type_rapport" id="type_rapport" required class="filter-input">
                        <option value="">--Type rapport--</option>
                        <option value="accident">Accident</option>
                        <option value="incident">Incident</option>
                        </select> &nbsp;
                        <button type="button" id="export-rapport"><i class="fa fa-file-image text-success"></i></button>
                    </form>
                    <div class="card-body">
                        <h5 class="card-title">Evolution du nombre de mort par site</h5>
                        <canvas id="rapportMort" width="400" height="400"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tableau de bord</h5>
                        <div id="placeholder" style="height: 420px;">
                            <div class="row">
                                <div class="col-6">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-user m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{active_users_count}}</h5>
                                       <small class="font-light">Total Utilisateur</small>
                                    </div>
                                </div>
                                 <div class="col-6">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-plus m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{Carte}}</h5>
                                       <small class="font-light">Total Carte</small>
                                    </div>
                                </div>
                                <div class="col-6 m-t-15">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-cart-plus m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{Visites}}</h5>
                                       <small class="font-light">Total Visite de site</small>
                                    </div>
                                </div>
                                 <div class="col-6 m-t-15">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-tag m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{Prelevements}}</h5>
                                       <small class="font-light">Total Prelevement</small>
                                    </div>
                                </div>
                                <div class="col-6 m-t-15">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-table m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{Bureaux}}</h5>
                                       <small class="font-light">Total BE</small>
                                    </div>
                                </div>
                                <div class="col-6 m-t-15">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-globe m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{Guides}}</h5>
                                       <small class="font-light">Total Guide</small>
                                    </div>
                                </div>
                                <div class="col-6 m-t-15">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-globe m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{rapportActivites}}</h5>
                                       <small class="font-light">Total Rapport</small>
                                    </div>
                                </div>
                                <div class="col-6 m-t-15">
                                    <div class="bg-success p-10 text-white text-center">
                                       <i class="fa fa-globe m-b-5 font-16"></i>
                                       <h5 class="m-b-0 m-t-5">{{Sites}}</h5>
                                       <small class="font-light">Total Sites</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p id="choices" class="m-t-20"></p>
                    </div>
                </div>
            </div>
        </div>
        <!-- ENd chart-1 -->
        <!-- Chart-2 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Gestion des conventions par regions</h5>
                        <div id="placeholder">
                                <form method="get" id="filterForm">
                                    <label for="" class="form-label font-italic font-weight-bold text-success">du</label>
                                    <input type="date" name="date_depart" id="date_depart" class="text-success font-italic font-weight-bold" required>
                                    <label for="" class="form-label font-italic font-weight-bold text-success">au</label>
                                    <input type="date" name="date_arrive" id="date_arrive" class="text-success font-italic font-weight-bold" required>
                                    &nbsp; &nbsp;
                                    <select name="statut" id="statut" required class="filter-input">
                                    <option value="">--Statut--</option>
                                    <option value="demande">En Demande</option>
                                    <option value="instruction">En instruction</option>
                                    <option value="signature">En signature</option>
                                    <option value="anuler">Anuler</option>
                                    <option value="convention">Validé</option>
                                    </select> &nbsp;
                                    <button type="button" id="export-btn"><i class="fa fa-file-image text-success"></i></button>
                                </form>
                                <div class="card-body">
                                    <canvas id="convention" width="300" height="300"></canvas>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Guide autorité par type de site</h5>
                        <div id="placeholder">
                                <form method="get" id="guide">
                                    <label for="" class="form-label font-italic font-weight-bold text-success">du</label>
                                    <input type="date" name="d1" id="d1" class="text-success font-italic font-weight-bold" required>
                                    <label for="" class="form-label font-italic font-weight-bold text-success">au</label>
                                    <input type="date" name="d2" id="d2" class="text-success font-italic font-weight-bold" required>
                                    &nbsp; &nbsp;
                                    <select name="type_site" id="type_site" required class="filter-input">
                                    <option value="">--Type de site--</option>
                                    {% for type_site in types %}
                                    <option value="{{type_site.id}}">{{type_site.libelle}}</option>
                                    {% endfor %}
                                    </select> &nbsp;
                                    <button type="button" id="exp1"><i class="fa fa-file-image text-success"></i></button>
                                </form>
                                <div class="card-body">
                                    <canvas id="chart1" width="300" height="250"></canvas>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ENd chart-2 -->
        <!-- Chart-3 -->
        <div class="row mt-3">
            <!-- start col- -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Nombre de covention signé par type d'autorisation</h5>
                        <div id="placeholder">
                                <form method="get" id="filterConv">
                                    <label for="" class="form-label font-italic font-weight-bold text-success">du</label>
                                    <input type="date" name="dep" id="dep" class="text-success font-italic font-weight-bold" required>
                                    <label for="" class="form-label font-italic font-weight-bold text-success">au</label>
                                    <input type="date" name="arr" id="arr" class="text-success font-italic font-weight-bold" required>
                                    &nbsp; &nbsp;
                                    <button type="button" id="btn1"><i class="fa fa-file-image text-success"></i></button>
                                </form>
                                <canvas id="boadConvention" width="200" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ENd col- -->
             <!-- START col- -->
            <div class="col-md-6">
                <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Export de données</h5>
                            <a type="button" href="{% url 'bunsess:export_conv_csv' %}" class="btn btn-success btn-sm">Liste des conventions en CSV</a>
                            <a type="button" href="{% url 'bunsess:export_site_csv' %}" class="btn btn-primary btn-sm">Liste des sites en CSV</a>
                           
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Export de données</h5>
                            <a type="button" href="{% url 'bunsess:export_conv_csv' %}" class="btn btn-success btn-sm">Liste des prelements en CSV</a>
                            <a type="button" href="{% url 'bunsess:export_site_csv' %}" class="btn btn-primary btn-sm">Lites des guide en CSV</a>
                           
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">Export de données</h5>
                            <a type="button" href="{% url 'bunsess:export_conv_csv' %}" class="btn btn-success btn-sm">Liste des rapport d'accident-incident en CSV</a>
                            <a type="button" href="{% url 'bunsess:export_site_csv' %}" class="btn btn-primary btn-sm">Liste des normes en CSV</a>
                           
                        </div>
                </div>
            </div>
            <!-- ENd col- -->
        </div>
        <!-- ENd chart-3 -->
    </div>






   <!-- START chart-1 -->
    <script>

        $(document).ready(function(){
            // Fonction pour obtenir une couleur aléatoire
            function getRandomColor() {
                return '#' + Math.floor(Math.random()*16777215).toString(16);
            }
        
            // Fonction pour mettre à jour le graphique
            function updateChart1() {
                var date_depart = $('#date_depart').val();
                var date_arrive = $('#date_arrive').val();
                var statut = $('#statut').val();
                
                if (!date_depart || !date_arrive) {
                    console.error('Les dates ne sont pas correctement définies.');
                    return;
                }
                // Envoyer la requête AJAX vers la vue Django avec les filtres
                $.ajax({
                    type: 'GET',
                    url: '{% url "bunsess:charts" %}',
                    data: {
                        'date_depart': date_depart,
                        'date_arrive': date_arrive,
                        'statut': statut,
                    },
                    success: function(data) {
                        // Générer des couleurs aléatoires pour chaque région
                        var colors = data.regions.map(function() {
                            return getRandomColor();
                        });
        
                        // Mettre à jour le graphique avec les nouvelles données
                        var ctxConv = document.getElementById('convention').getContext('2d');
                       
                        convChart = new Chart(ctxConv, {
                            type: 'bar', 
                            data: {
                                labels: data.regions,
                                datasets: [
                                    {
                                        label: 'Nombre de demandes par région',
                                        data: data.nombre_demandes,
                                        backgroundColor: colors,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                    },
                                    y: {
                                        beginAtZero: true,
                                    },
                                },
                            },
                        });
                    },
                    error: function(error) {
                        console.log('Erreur AJAX:', error);
                    }
                });
            }
         // Ajouter des gestionnaires d'événements pour les changements dans le formulaire
        $('#date_depart, #date_arrive, #statut').on('change', function() {
            updateChart1();  // Mettre à jour le graphique lorsque les champs changent
        });
    
        // Appeler la fonction updateChart() pour charger le graphique au chargement initial
        updateChart1();
        
        
            // Export chart as image
            document.getElementById('export-btn').addEventListener('click', function () {
                var canvas = document.getElementById('convention');
                var link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'DemandeConvention.png';
                link.click();
            });

        });
        
    </script>
    
 <!-- ENd chart-1 -->


  <!-- START chart-2 -->
<script>
    $(document).ready(function(){
        // Fonction pour mettre à jour le graphique
        function updateChart() {
            var date_depart = $('#start_date').val(); 
            var date_arrive = $('#end_date').val();    
            var statut = $('#type_rapport').val();   
              

            $.ajax({
                url: '{% url "bunsess:rapportMort" %}',
                type: 'GET',
                dataType: 'json',
                data: $('#filterRpport').serialize(),  // Envoyer les données du formulaire
                success: function(data) {
                    if (data.error) {
                        console.error('Erreur lors de la récupération des données:', data.error);
                        return;
                    }
    
                    if (!data.dates || !data.total_hommes || !data.total_femmes || !data.total_enfants) {
                        console.error('Données manquantes pour créer le graphique.');
                        return;
                    }
    
                    // Créer le graphique en utilisant Chart.js
                    var ctxRapp = document.getElementById('rapportMort').getContext('2d');
                    var mortRapp = new Chart(ctxRapp, {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [
                                {
                                    label: 'Hommes',
                                    data: data.total_hommes,
                                    backgroundColor: '#ff5733',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1,
                                    fill: false
                                },
                                {
                                    label: 'Femmes',
                                    data: data.total_femmes,
                                    backgroundColor: '#f5d017',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1,
                                    fill: false
                                },
                                {
                                    label: 'Enfants',
                                    data: data.total_enfants,
                                    backgroundColor: '#f58317',
                                    borderColor: 'rgba(255, 206, 86, 1)',
                                    borderWidth: 1,
                                    fill: false
                                }
                            ]
                        }

                        
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Erreur lors de la requête AJAX:', status, error);
                }
            });
        }
    
        // Ajouter des gestionnaires d'événements pour les changements dans le formulaire
        $('#start_date, #end_date, #type_rapport').on('change', function() {
            updateChart();  // Mettre à jour le graphique lorsque les champs changent
        });
    
        // Appeler la fonction updateChart() pour charger le graphique au chargement initial
        updateChart();


        document.getElementById('export-rapport').addEventListener('click', function () {
            var canvas = document.getElementById('rapportMort');
            var link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'rapportMort.png';
            link.click();
        });
    
    });
    
</script>
    
 <!-- ENd chart-2 -->


 <!-- START chart-3 -->

 <script>
    $(document).ready(function(){
        // Fonction pour mettre à jour le graphique
        function updateChartconv() {
            var date_depart = $('#dep').val(); 
            var date_arrive = $('#arr').val();       
              

            $.ajax({
                url: '{% url "bunsess:boadConvention" %}',
                type: 'GET',
                dataType: 'json',
                data: $('#filterConv').serialize(),  // Envoyer les données du formulaire
                success: function(data) {
                    console.log(data)
                    if (data.error) {
                        console.error('Erreur lors de la récupération des données:', data.error);
                        return;
                    }
    
                    if (!data.labels || !data.counts) {
                        console.error('Données manquantes pour créer le graphique.');
                        return;
                    }

                    // Mettre à jour le graphique en utilisant Chart.js
                    var ctxBoadConv = document.getElementById('boadConvention').getContext('2d');
                   
                    var boadConv = new Chart(ctxBoadConv, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [
                                {
                                    label: 'Nombre de Conventions par Type d\'Autorisation',
                                    data: data.counts,  // Utiliser data.counts au lieu de data.total_hommes
                                    backgroundColor: ['#ff5733', '#36a2eb', '#ffcc29'], // Couleurs pour chaque segment
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1,
                                    fill: false
                                },
                            ]
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Erreur lors de la requête AJAX:', status, error);
                }
            });
        }
    
        // Ajouter des gestionnaires d'événements pour les changements dans le formulaire
        $('#dep, #arr').on('change', function() {
            updateChartconv();  // Mettre à jour le graphique lorsque les champs changent
        });
    
        // Appeler la fonction updateChart() pour charger le graphique au chargement initial
        updateChartconv();


        document.getElementById('btn1').addEventListener('click', function () {
            var canvas = document.getElementById('boadConvention');
            var link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'boadConvention.png';
            link.click();
        });
    
    });
</script>

 <!-- ENd chart-3 -->



 <!-- START chart-4 -->
<script>

    $(document).ready(function () {
        // Fonction pour mettre à jour le graphique
        function updateChartGuide() {
            var d1 = $('#d1').val();
            var d2 = $('#d2').val();
    
            $.ajax({
                url: '{% url "bunsess:guideAutorite" %}',
                type: 'GET',
                dataType: 'json',
                data: $('#guide').serialize(),
                success: function (data) {
                    console.log(data);
                    if (data.error) {
                        console.error('Erreur lors de la récupération des données:', data.error);
                        return;
                    }
    
                    if (!data.labels || !data.counts) {
                        console.error('Données manquantes pour créer le graphique.');
                        return;
                    }
    
                    // Mettre à jour le graphique en utilisant Chart.js
                    var guideAut = document.getElementById('chart1').getContext('2d');
                   
                    var guideChart = new Chart(guideAut, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [
                                {
                                    label: "Nombre de visite d'autorité par type de site",
                                    data: data.counts,
                                    backgroundColor: ['#ff5733', '#36a2eb', '#ffcc29'],
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1,
                                    fill: false
                                },
                            ]
                        }
                        
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Erreur lors de la requête AJAX:', status, error);
                }
            });
        }
    
        // Ajouter des gestionnaires d'événements pour les changements dans le formulaire
        $('#dep, #arr, #type_site').on('change', function () {
            updateChartGuide();  // Mettre à jour le graphique lorsque les champs changent
        });
    
        // Appeler la fonction updateChart() pour charger le graphique au chargement initial
        updateChartGuide();
    
        // Ajouter un gestionnaire d'événements pour le bouton d'export
        $('#exp1').on('click', function () {
            var canvas = document.getElementById('chart1');
            var link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'updateChartGuide.png';
            link.click();
        });
    });
    

</script>


 <!-- ENd chart-4-->

{% endblock %}